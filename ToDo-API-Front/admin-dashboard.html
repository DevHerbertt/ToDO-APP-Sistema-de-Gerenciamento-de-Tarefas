<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | ToDo App</title>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --border: #e0e0e0;
      --bg: #f5f7fa;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }
    
    .container {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      color: white;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .logo {
      text-align: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo h2 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .logo p {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .nav-menu {
      margin-top: 30px;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
    }
    
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .nav-item.active {
      background-color: rgba(255, 255, 255, 0.2);
      border-left: 4px solid white;
    }
    
    .nav-item i {
      margin-right: 10px;
      font-size: 18px;
    }
    
    /* Main Content */
    .main-content {
      padding: 30px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 28px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .logout-btn {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 15px;
    }
    
    /* Section Styles */
    .section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .section-header h2 {
      font-size: 20px;
    }
    
    .add-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .add-btn i {
      margin-right: 5px;
    }
    
    /* Filter Section */
    .filter-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .filter-form {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: end;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background-color: var(--bg);
      font-weight: 600;
    }
    
    tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-primary {
      background-color: #e6f0ff;
      color: var(--primary);
    }
    
    .badge-success {
      background-color: #e6f7ee;
      color: var(--success);
    }
    
    .badge-warning {
      background-color: #fff4e5;
      color: var(--warning);
    }
    
    .badge-danger {
      background-color: #ffebee;
      color: var(--danger);
    }
    
    .badge-info {
      background-color: #e1f5fe;
      color: var(--info);
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }
    
    .edit-btn {
      background-color: var(--warning);
      color: white;
    }
    
    .delete-btn {
      background-color: var(--danger);
      color: white;
    }
    
    .role-btn {
      background-color: var(--info);
      color: white;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      font-size: 22px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 16px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .cancel-btn {
      background-color: var(--text-light);
      color: white;
    }
    
    .save-btn {
      background-color: var(--primary);
      color: white;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .alert-success {
      background-color: var(--success);
    }
    
    .alert-error {
      background-color: var(--danger);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .filter-form {
        flex-direction: column;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <h2>ToDo App</h2>
        <p>Admin Dashboard</p>
      </div>
      <div class="nav-menu">
        <div class="nav-item active" data-tab="users">
          <i class="fas fa-users"></i>
          <span>Users</span>
        </div>
        <div class="nav-item" data-tab="tasks">
          <i class="fas fa-tasks"></i>
          <span>All Tasks</span>
        </div>
        <div class="nav-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>Admin Dashboard</h1>
        <div class="user-info">
          <img src="https://ui-avatars.com/api/?name=Admin+User" alt="Admin">
          <span>Admin User</span>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="users">Users</div>
        <div class="tab" data-tab="tasks">All Tasks</div>
      </div>
      
      <!-- Users Tab Content -->
      <div class="tab-content active" id="usersTab">
        <div class="filter-section">
          <div class="section-header">
            <h2>Filter Users</h2>
          </div>
          <form id="userFilterForm" class="filter-form">
            <div class="form-group filter-group">
              <label for="userSearch">Search Users</label>
              <input type="text" id="userSearch" placeholder="Search by name or email...">
            </div>
            <button type="button" class="filter-btn" id="searchUsersBtn">
              <i class="fas fa-search"></i> Search
            </button>
            <button type="button" class="filter-btn" id="refreshUsersBtn">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </form>
        </div>
        
        <div class="section">
          <div class="section-header">
            <h2>User Management</h2>
            <button class="add-btn" id="addUserBtn">
              <i class="fas fa-plus"></i> Add User
            </button>
          </div>
          <div class="table-container">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Tasks Tab Content -->
      <div class="tab-content" id="tasksTab">
        <div class="filter-section">
          <div class="section-header">
            <h2>Filter Tasks</h2>
          </div>
          <form id="taskFilterForm" class="filter-form">
            <div class="form-group filter-group">
              <label for="taskSearch">Search Tasks</label>
              <input type="text" id="taskSearch" placeholder="Search by title or description...">
            </div>
            <div class="form-group filter-group">
              <label for="taskUserFilter">Filter by User</label>
              <select id="taskUserFilter">
                <option value="">All Users</option>
                <!-- Users will be loaded here -->
              </select>
            </div>
            <button type="button" class="filter-btn" id="searchTasksBtn">
              <i class="fas fa-search"></i> Search
            </button>
            <button type="button" class="filter-btn" id="refreshTasksBtn">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </form>
        </div>
        
        <div class="section">
          <div class="section-header">
            <h2>All Tasks</h2>
            <button class="add-btn" id="addTaskBtn">
              <i class="fas fa-plus"></i> Add Task
            </button>
          </div>
          <div class="table-container">
            <table id="tasksTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>User</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Due Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tasksTableBody">
                <!-- Tasks will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="userModalTitle">Add New User</h2>
        <button class="close-btn" id="closeUserModalBtn">&times;</button>
      </div>
      <form id="userForm">
        <input type="hidden" id="userId">
        <div class="form-group">
          <label for="userName">Name</label>
          <input type="text" id="userName" name="name" required>
        </div>
        <div class="form-group">
          <label for="userEmail">Email</label>
          <input type="email" id="userEmail" name="email" required>
        </div>
        <div class="form-group">
          <label for="userPassword">Password</label>
          <input type="password" id="userPassword" name="password">
        </div>
        <div class="form-group">
          <label for="userRole">Role</label>
          <select id="userRole" name="role" required>
            <option value="USER">User</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="action-btn cancel-btn" id="cancelUserBtn">Cancel</button>
          <button type="submit" class="action-btn save-btn">Save User</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add/Edit Task Modal -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="taskModalTitle">Add New Task</h2>
        <button class="close-btn" id="closeTaskModalBtn">&times;</button>
      </div>
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <div class="form-group">
          <label for="taskTitle">Title</label>
          <input type="text" id="taskTitle" name="title" required>
        </div>
        <div class="form-group">
          <label for="taskDescription">Description</label>
          <textarea id="taskDescription" name="description"></textarea>
        </div>
        <div class="form-group">
          <label for="taskUser">User</label>
          <select id="taskUser" name="userId" required>
            <!-- Users will be loaded here -->
          </select>
        </div>
        <div class="form-group">
          <label for="taskPriority">Priority</label>
          <select id="taskPriority" name="priority" required>
            <option value="LOW">Low</option>
            <option value="MEDIUM" selected>Medium</option>
            <option value="HIGH">High</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskDueDate">Due Date</label>
          <input type="date" id="taskDueDate" name="dueDate">
        </div>
        <div class="modal-footer">
          <button type="button" class="action-btn cancel-btn" id="cancelTaskBtn">Cancel</button>
          <button type="submit" class="action-btn save-btn">Save Task</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Change Role Modal -->
  <div class="modal" id="roleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Change User Role</h2>
        <button class="close-btn" id="closeRoleModalBtn">&times;</button>
      </div>
      <form id="roleForm">
        <input type="hidden" id="roleUserId">
        <div class="form-group">
          <label for="newRole">New Role</label>
          <select id="newRole" name="newRole" required>
            <option value="USER">User</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="action-btn cancel-btn" id="cancelRoleBtn">Cancel</button>
          <button type="submit" class="action-btn save-btn">Change Role</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { 
      fetchAllUsers, 
      createTaskForUser, 
      deleteAnyTask, 
      getAllTasksForAdmin, 
      changeUserRole, 
      deleteUser,
      logout,
      isAuthenticated,
      registerUser
    } from './api.js';

    // Global variables
    let users = [];
    let tasks = [];
    let currentUserId = null;
    let currentTaskId = null;
    
    // DOM Elements
    const usersTableBody = document.getElementById('usersTableBody');
    const tasksTableBody = document.getElementById('tasksTableBody');
    const userForm = document.getElementById('userForm');
    const taskForm = document.getElementById('taskForm');
    const roleForm = document.getElementById('roleForm');
    const userModal = document.getElementById('userModal');
    const taskModal = document.getElementById('taskModal');
    const roleModal = document.getElementById('roleModal');
    const addUserBtn = document.getElementById('addUserBtn');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const closeUserModalBtn = document.getElementById('closeUserModalBtn');
    const closeTaskModalBtn = document.getElementById('closeTaskModalBtn');
    const closeRoleModalBtn = document.getElementById('closeRoleModalBtn');
    const cancelUserBtn = document.getElementById('cancelUserBtn');
    const cancelTaskBtn = document.getElementById('cancelTaskBtn');
    const cancelRoleBtn = document.getElementById('cancelRoleBtn');
    const userModalTitle = document.getElementById('userModalTitle');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const logoutBtn = document.getElementById('logoutBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const navItems = document.querySelectorAll('.nav-item');
    const searchUsersBtn = document.getElementById('searchUsersBtn');
    const refreshUsersBtn = document.getElementById('refreshUsersBtn');
    const searchTasksBtn = document.getElementById('searchTasksBtn');
    const refreshTasksBtn = document.getElementById('refreshTasksBtn');
    const userSearch = document.getElementById('userSearch');
    const taskSearch = document.getElementById('taskSearch');
    const taskUserFilter = document.getElementById('taskUserFilter');
    const taskUserSelect = document.getElementById('taskUser');
    
    // Check authentication and admin role
    if (!isAuthenticated()) {
      window.location.href = 'login.html';
    }

    // Show alert function
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    // Fetch all users
    async function loadUsers() {
      try {
        users = await fetchAllUsers();
        renderUsers();
        
        // Populate user select in task form
        taskUserSelect.innerHTML = '<option value="">Select User</option>';
        
        // Populate user filter in task filter
        taskUserFilter.innerHTML = '<option value="">All Users</option>';
        
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.name || user.email;
          taskUserSelect.appendChild(option.cloneNode(true));
          taskUserFilter.appendChild(option.cloneNode(true));
        });
      } catch (error) {
        showAlert('Failed to load users: ' + error.message, 'error');
      }
    }
    
    // Fetch all tasks
    async function loadTasks() {
      try {
        tasks = await getAllTasksForAdmin();
        console.log('Tasks loaded:', tasks); // Debug
        renderTasks();
      } catch (error) {
        showAlert('Failed to load tasks: ' + error.message, 'error');
      }
    }
    
    // Filter users based on search term
    function filterUsers(searchTerm = '') {
      if (!searchTerm) {
        renderUsers();
        return;
      }
      
      const term = searchTerm.toLowerCase();
      const filteredUsers = users.filter(user => 
        (user.name && user.name.toLowerCase().includes(term)) ||
        (user.email && user.email.toLowerCase().includes(term))
      );
      
      renderUsers(filteredUsers);
    }
    
    // Filter tasks based on search term and user filter
    function filterTasks(searchTerm = '', userId = '') {
      let filteredTasks = tasks;
      
      // Filter by search term
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredTasks = filteredTasks.filter(task => 
          (task.title && task.title.toLowerCase().includes(term)) ||
          (task.description && task.description.toLowerCase().includes(term))
        );
      }
      
      // Filter by user
      if (userId) {
        filteredTasks = filteredTasks.filter(task => task.creator?.id == userId);
      }
      
      renderTasks(filteredTasks);
    }
    
    // Render users to the table
    function renderUsers(usersToRender = users) {
      usersTableBody.innerHTML = '';
      
      if (!usersToRender || usersToRender.length === 0) {
        usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users found</td></tr>';
        return;
      }
      
      usersToRender.forEach(user => {
        const row = document.createElement('tr');
        
        const roleBadgeClass = user.role === 'ADMIN' ? 'badge-primary' : 'badge-info';
        
        row.innerHTML = `
          <td>${user.id}</td>
          <td>${user.name || 'No name'}</td>
          <td>${user.email}</td>
          <td><span class="badge ${roleBadgeClass}">${user.role}</span></td>
          <td>
            <button class="action-btn role-btn" data-id="${user.id}">
              <i class="fas fa-user-cog"></i>
            </button>
            <button class="action-btn edit-btn" data-id="${user.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" data-id="${user.id}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        usersTableBody.appendChild(row);
      });
      
      // Add event listeners to action buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.target.closest('button').dataset.id;
          editUser(userId);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.target.closest('button').dataset.id;
          deleteUserHandler(userId);
        });
      });
      
      document.querySelectorAll('.role-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userId = e.target.closest('button').dataset.id;
          openRoleModal(userId);
        });
      });
    }
    
    // Render tasks to the table
    function renderTasks(tasksToRender = tasks) {
      tasksTableBody.innerHTML = '';
      
      if (!tasksToRender || tasksToRender.length === 0) {
        tasksTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No tasks found</td></tr>';
        return;
      }
      
      tasksToRender.forEach(task => {
        const row = document.createElement('tr');
        
        // Handle task data safely
        const userName = task.creator?.name || 'Unknown';
        const dueDateFormatted = task.dueData ? new Date(task.dueData).toLocaleDateString('pt-BR') : '-';
        const priority = task.priority || 'MEDIUM';
        const status = task.status ? 'COMPLETED' : 'PENDING';
        
        const statusBadgeClass = task.status ? 'badge-success' : 'badge-warning';
        const priorityBadgeClass = priority === 'HIGH' ? 'badge-danger' : 
                                  priority === 'MEDIUM' ? 'badge-warning' : 'badge-info';
        
        row.innerHTML = `
          <td>${task.id}</td>
          <td>${task.title || 'No title'}</td>
          <td>${userName}</td>
          <td><span class="badge ${statusBadgeClass}">${status}</span></td>
          <td><span class="badge ${priorityBadgeClass}">${priority}</span></td>
          <td>${dueDateFormatted}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${task.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" data-id="${task.id}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tasksTableBody.appendChild(row);
      });
      
      // Add event listeners to action buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const taskId = e.target.closest('button').dataset.id;
          editTask(taskId);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const taskId = e.target.closest('button').dataset.id;
          deleteTaskHandler(taskId);
        });
      });
    }
    
    // Add new user
    async function addUserHandler(userData) {
      try {
        await registerUser(userData.name, userData.email, userData.password);
        await loadUsers();
        closeModal(userModal);
        showAlert('User created successfully!');
      } catch (error) {
        showAlert('Failed to create user: ' + error.message, 'error');
      }
    }
    
    // Delete user
    async function deleteUserHandler(userId) {
      if (!confirm('Are you sure you want to delete this user? All their tasks will also be deleted.')) return;
      
      try {
        await deleteUser(userId);
        await loadUsers();
        await loadTasks();
        showAlert('User deleted successfully!');
      } catch (error) {
        showAlert('Failed to delete user: ' + error.message, 'error');
      }
    }
    
    // Change user role
    async function changeUserRoleHandler(userId, newRole) {
      try {
        await changeUserRole(userId, newRole);
        await loadUsers();
        closeModal(roleModal);
        showAlert('User role updated successfully!');
      } catch (error) {
        showAlert('Failed to change user role: ' + error.message, 'error');
      }
    }
    
    // Add new task
    async function addTaskHandler(taskData) {
      try {
        await createTaskForUser(taskData.userId, {
          title: taskData.title,
          description: taskData.description,
          priority: taskData.priority,
          dueDate: taskData.dueDate
        });
        await loadTasks();
        closeModal(taskModal);
        showAlert('Task created successfully!');
      } catch (error) {
        showAlert('Failed to create task: ' + error.message, 'error');
      }
    }
    
    // Delete task
    async function deleteTaskHandler(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      try {
        await deleteAnyTask(taskId);
        await loadTasks();
        showAlert('Task deleted successfully!');
      } catch (error) {
        showAlert('Failed to delete task: ' + error.message, 'error');
      }
    }
    
    // Edit user - open modal with user data
    function editUser(userId) {
      const user = users.find(u => u.id == userId);
      if (!user) return;
      
      currentUserId = userId;
      userModalTitle.textContent = 'Edit User';
      
      document.getElementById('userId').value = user.id;
      document.getElementById('userName').value = user.name;
      document.getElementById('userEmail').value = user.email;
      document.getElementById('userPassword').value = '';
      document.getElementById('userRole').value = user.role;
      
      openModal(userModal);
    }
    
    // Edit task - open modal with task data
    function editTask(taskId) {
      const task = tasks.find(t => t.id == taskId);
      if (!task) return;
      
      currentTaskId = taskId;
      taskModalTitle.textContent = 'Edit Task';
      
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskTitle').value = task.title;
      document.getElementById('taskDescription').value = task.description || '';
      document.getElementById('taskUser').value = task.creator?.id || '';
      document.getElementById('taskPriority').value = task.priority;
      document.getElementById('taskDueDate').value = task.dueData || '';
      
      openModal(taskModal);
    }
    
    // Open modal for new user
    function openNewUserModal() {
      currentUserId = null;
      userModalTitle.textContent = 'Add New User';
      userForm.reset();
      openModal(userModal);
    }
    
    // Open modal for new task
    function openNewTaskModal() {
      currentTaskId = null;
      taskModalTitle.textContent = 'Add New Task';
      taskForm.reset();
      openModal(taskModal);
    }
    
    // Open role change modal
    function openRoleModal(userId) {
      const user = users.find(u => u.id == userId);
      if (!user) return;
      
      document.getElementById('roleUserId').value = user.id;
      document.getElementById('newRole').value = user.role;
      
      openModal(roleModal);
    }
    
    // Open modal
    function openModal(modal) {
      modal.style.display = 'flex';
    }
    
    // Close modal
    function closeModal(modal) {
      modal.style.display = 'none';
    }
    
    // Switch tabs
    function switchTab(tabId) {
      // Update tabs
      tabs.forEach(tab => {
        if (tab.dataset.tab === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // Update tab contents
      tabContents.forEach(content => {
        if (content.id === `${tabId}Tab`) {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });
      
      // Update nav items
      navItems.forEach(item => {
        if (item.dataset.tab === tabId) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // Event Listeners
    addUserBtn.addEventListener('click', openNewUserModal);
    addTaskBtn.addEventListener('click', openNewTaskModal);
    closeUserModalBtn.addEventListener('click', () => closeModal(userModal));
    closeTaskModalBtn.addEventListener('click', () => closeModal(taskModal));
    closeRoleModalBtn.addEventListener('click', () => closeModal(roleModal));
    cancelUserBtn.addEventListener('click', () => closeModal(userModal));
    cancelTaskBtn.addEventListener('click', () => closeModal(taskModal));
    cancelRoleBtn.addEventListener('click', () => closeModal(roleModal));
    
    userForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value
      };
      
      if (currentUserId) {
        // In a real app, you would implement user update
        showAlert('User update functionality would be implemented here', 'info');
      } else {
        addUserHandler(userData);
      }
    });
    
    taskForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const taskData = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        userId: document.getElementById('taskUser').value,
        priority: document.getElementById('taskPriority').value,
        dueDate: document.getElementById('taskDueDate').value || null
      };
      
      if (currentTaskId) {
        // In a real app, you would implement task update
        showAlert('Task update functionality would be implemented here', 'info');
      } else {
        addTaskHandler(taskData);
      }
    });
    
    roleForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const userId = document.getElementById('roleUserId').value;
      const newRole = document.getElementById('newRole').value;
      
      changeUserRoleHandler(userId, newRole);
    });
    
    // Tab click events
    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });
    
    // Nav item click events
    navItems.forEach(item => {
      if (item.dataset.tab) {
        item.addEventListener('click', () => switchTab(item.dataset.tab));
      }
    });
    
    // Search and filter events
    searchUsersBtn.addEventListener('click', () => filterUsers(userSearch.value));
    refreshUsersBtn.addEventListener('click', () => {
      userSearch.value = '';
      loadUsers();
    });
    
    searchTasksBtn.addEventListener('click', () => filterTasks(taskSearch.value, taskUserFilter.value));
    refreshTasksBtn.addEventListener('click', () => {
      taskSearch.value = '';
      taskUserFilter.value = '';
      loadTasks();
    });
    
    // Enter key events for search
    userSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        filterUsers(userSearch.value);
      }
    });
    
    taskSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        filterTasks(taskSearch.value, taskUserFilter.value);
      }
    });
    
    // User filter change event
    taskUserFilter.addEventListener('change', () => {
      filterTasks(taskSearch.value, taskUserFilter.value);
    });
    
    logoutBtn.addEventListener('click', () => {
      logout();
    });
    
    // Initialize
    loadUsers();
    loadTasks();
  </script>
</body>
</html>